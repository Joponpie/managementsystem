<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品上架排程管理系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', sans-serif;
            background: #f5f7fa;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .brand-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .brand-selector h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .brand-tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }

        .action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255,107,107,0.4);
        }

        .action-btn.secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .action-btn.secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(78,205,196,0.4);
        }

        .brand-tab {
            padding: 12px 24px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .brand-tab:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .brand-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: #667eea;
            color: white;
        }

        .phase {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .phase-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .phase-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .phase-title h2 {
            font-size: 22px;
            color: #333;
        }

        .channels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .channel-card {
            background: #f8f9fa;
            padding: 18px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            transition: all 0.3s ease;
        }

        .channel-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .channel-card.online {
            border-left-color: #667eea;
        }

        .channel-card.offline {
            border-left-color: #f093fb;
        }

        .channel-card.group {
            border-left-color: #ffa726;
        }

        .channel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .channel-name {
            font-weight: 600;
            font-size: 16px;
            color: #333;
        }

        .channel-type {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            background: white;
            color: #666;
        }

        .brand-section {
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }

        .brand-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .brand-section-header:hover {
            background: #e9ecef;
        }

        .brand-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
        }

        .sku-list {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .sku-list.expanded {
            max-height: 800px;
        }

        .sku-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            font-size: 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sku-item:last-child {
            border-bottom: none;
        }

        .sku-item input[type="checkbox"] {
            cursor: pointer;
        }

        .sku-name {
            flex: 1;
            color: #666;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
        }

        .status-indicator.selected {
            background: #4caf50;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h2 {
            font-size: 24px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 32px;
            height: 32px;
        }

        .close-btn:hover {
            color: #333;
        }

        .brand-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .brand-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }

        .brand-card-header {
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
            color: #333;
        }

        .select-all-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .select-all-btn:hover {
            background: #5568d3;
        }

        .save-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin-top: 20px;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
        }

        .material-btn {
            background: #ffa726;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            margin-top: 8px;
            width: 100%;
            transition: all 0.3s;
        }

        .material-btn:hover {
            background: #fb8c00;
            transform: translateY(-1px);
        }

        .material-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #e0e0e0;
        }

        .material-item {
            background: #fff;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 6px;
            border-left: 3px solid #ffa726;
        }

        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .material-sku-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .material-sku-name.unselected {
            color: #999;
            font-style: italic;
        }

        /* 新增: 已完成的SKU名稱加上刪除線 */
        .material-sku-name.completed {
            text-decoration: line-through;
            color: #999;
        }

        .material-types {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .material-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .material-checkbox:hover {
            background: #e9ecef;
        }

        .material-checkbox input {
            cursor: pointer;
        }

        .material-note {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
            resize: vertical;
            min-height: 60px;
        }

        .material-summary {
            background: linear-gradient(135deg, #ffa72620, #ff6b6b10);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .material-summary h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .material-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .material-stat-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .material-stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #ffa726;
        }

        .material-stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #ffa726;
            border-color: #ffa726;
            color: white;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
        }

        .summary-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .summary-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .summary-table tr:hover {
            background: #f8f9fa;
        }

        .channel-tag {
            display: inline-block;
            padding: 3px 8px;
            margin: 2px;
            background: #e3f2fd;
            border-radius: 4px;
            font-size: 11px;
            color: #1976d2;
        }

        .material-tag {
            display: inline-block;
            padding: 2px 6px;
            margin: 2px;
            background: #fff3e0;
            border-radius: 3px;
            font-size: 11px;
            color: #f57c00;
        }

        .price-input {
            width: 100px;
            padding: 6px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 13px;
        }

        .price-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .price-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .price-label {
            min-width: 120px;
            font-size: 13px;
            color: #666;
        }

        .export-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: auto;
        }

        .export-btn:hover {
            background: #45a049;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group label {
            font-weight: 600;
            margin-right: 10px;
            color: #666;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .filter-btn.active {
            background: #667eea;
            border-color: #667eea;
            color: white;
        }
        
        /* 刪除按鈕樣式 */
        .delete-btn {
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            transition: color 0.2s;
        }
        .delete-btn:hover {
            color: #ee5a52;
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .channels-grid {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }

            .brand-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📦 商品上架排程管理系統</h1>
            <p>4 個品牌 × 65 個 SKU × 51 個通路</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <h3>總通路數</h3>
                <div class="number">51</div>
            </div>
            <div class="stat-card">
                <h3>線上通路</h3>
                <div class="number">12</div>
            </div>
            <div class="stat-card">
                <h3>線下通路</h3>
                <div class="number">19</div>
            </div>
            <div class="stat-card">
                <h3>團購主</h3>
                <div class="number">20</div>
            </div>
            <div class="stat-card">
                <h3>總品牌數</h3>
                <div class="number">4</div>
            </div>
            <div class="stat-card">
                <h3>總 SKU 數</h3>
                <div class="number">65</div>
            </div>
            <div class="stat-card">
                <h3>上架完成度</h3>
                <div class="number" id="completionRate">0%</div>
            </div>
        </div>

        <div class="brand-selector">
            <h3>🎯 品牌篩選</h3>
            <div class="brand-tabs">
                <div class="brand-tab active" onclick="filterBrand('all')">全部顯示</div>
                <div class="brand-tab" onclick="filterBrand('iFind')">📍 iFind (19)</div>
                <div class="brand-tab" onclick="filterBrand('LOHOY')">☂️ LOHOY (31)</div>
                <div class="brand-tab" onclick="filterBrand('HappyNut')">🥜 Happy Nut (5)</div>
                <div class="brand-tab" onclick="filterBrand('NETTEC')">🪥 優樂 (10)</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn primary" onclick="openMaterialSummary()">
                📋 素材需求總整理
            </button>
            <button class="action-btn secondary" onclick="openGlobalPriceManager()">
                💰 全通路價格總覽
            </button>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label>通路類型：</label>
                <button class="filter-btn active" onclick="filterChannelType('all')">全部</button>
                <button class="filter-btn" onclick="filterChannelType('online')">線上通路 (12)</button>
                <button class="filter-btn" onclick="filterChannelType('offline')">線下通路 (19)</button>
                <button class="filter-btn" onclick="filterChannelType('group')">團購主 (20)</button>
            </div>
        </div>

        <div class="material-summary">
            <h3>📸 素材需求總覽</h3>
            <div class="material-stats">
                <div class="material-stat-item">
                    <div class="material-stat-number" id="totalMaterialNeeded">0</div>
                    <div class="material-stat-label">待補素材</div>
                </div>
                <div class="material-stat-item">
                    <div class="material-stat-number" id="totalMaterialComplete">0</div>
                    <div class="material-stat-label">已完成</div>
                </div>
                <div class="material-stat-item">
                    <div class="material-stat-number" id="materialProgress">0%</div>
                    <div class="material-stat-label">完成度</div>
                </div>
            </div>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-title">
                    <span class="phase-badge">第一波</span>
                    <h2>線上通路</h2>
                </div>
                <span style="color: #666; font-size: 14px;">📱 共 13 個通路</span>
            </div>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                🎯 目標：各大電商平台、品牌官網、垂直電商等線上通路
            </p>
            <div class="channels-grid" id="phase1"></div>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-title">
                    <span class="phase-badge">第二波</span>
                    <h2>線下通路</h2>
                </div>
                <span style="color: #666; font-size: 14px;">🏪 共 19 個通路</span>
            </div>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                🎯 目標：實體零售商、批發代理商、特殊通路等線下通路
            </p>
            <div class="channels-grid" id="phase2"></div>
        </div>

        <div class="phase">
            <div class="phase-header">
                <div class="phase-title">
                    <span class="phase-badge">第三波</span>
                    <h2>團購主</h2>
                </div>
                <span style="color: #666; font-size: 14px;">👥 共 20 個團購主</span>
            </div>
            <p style="color: #666; margin-bottom: 20px; font-size: 14px;">
                🎯 目標：各大團購主、KOL、社群團購通路
            </p>
            <div class="channels-grid" id="phase3"></div>
        </div>
    </div>

    <div class="modal" id="skuModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">選擇上架商品</h2>
                <button class="close-btn" onclick="closeModal()">×</button>
            </div>
            <button class="select-all-btn" onclick="selectAllSKUs()">全選所有商品</button>
            <div class="brand-grid" id="skuBrandGrid"></div>
            <button class="save-btn" onclick="saveSKUSelection()">儲存選擇</button>
        </div>
    </div>

    <div class="modal" id="materialModal">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h2 id="materialModalTitle">素材需求管理</h2>
                <button class="close-btn" onclick="closeMaterialModal()">×</button>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchMaterialTab('needed')">缺素材 (<span id="neededCount">0</span>)</button>
                <button class="tab-btn" onclick="switchMaterialTab('complete')">已完成 (<span id="completeCount">0</span>)</button>
            </div>

            <div id="materialContent"></div>
            
            <button class="save-btn" onclick="saveMaterialNeeds()">儲存素材需求</button>
        </div>
    </div>

    <div class="modal" id="materialSummaryModal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h2>📋 素材需求總整理</h2>
                <button class="close-btn" onclick="closeMaterialSummary()">×</button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <p style="color: #666;">所有通路的素材需求彙整，方便設計師統一製作</p>
                <button class="export-btn" onclick="exportMaterialSummary()">匯出 Excel</button>
            </div>
            
            <div id="materialSummaryContent" style="overflow-x: auto;"></div>
        </div>
    </div>

    <div class="modal" id="channelPriceModal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="modal-header">
                <h2 id="channelPriceTitle">通路定價管理</h2>
                <button class="close-btn" onclick="closeChannelPriceManager()">×</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <p style="color: #666;">設定此通路的商品售價和成本</p>
            </div>
            
            <div id="channelPriceContent" style="overflow-y: auto; max-height: 60vh;"></div>
            
            <button class="save-btn" onclick="saveChannelPrices()">儲存定價</button>
        </div>
    </div>

    <div class="modal" id="priceModal">
        <div class="modal-content" style="max-width: 95%; max-height: 90vh;">
            <div class="modal-header">
                <h2>💰 全通路價格總覽</h2>
                <button class="close-btn" onclick="closePriceManager()">×</button>
            </div>
            
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <p style="color: #666;">查看所有通路的定價設定</p>
                <button class="export-btn" onclick="exportPriceSummary()">匯出價格表</button>
            </div>
            
            <div id="priceContent" style="overflow: auto;"></div>
        </div>
    </div>

    <script>
        // ====================================================================
        // I. 核心匯出工具函式
        // ====================================================================

        function exportTableToCSV(tableId, filename) {
            const tableContainer = document.getElementById(tableId);
            if (!tableContainer) {
                alert('找不到匯出表格容器！');
                return;
            }
            const table = tableContainer.querySelector('table');
            if (!table) {
                alert('找不到匯出表格內容！');
                return;
            }

            const rows = table.querySelectorAll('tr');
            let csv = [];

            // 處理標題行 (TH)
            const headerRow = rows[0];
            const headerCells = headerRow.querySelectorAll('th');
            let header = [];
            headerCells.forEach(cell => {
                let text = cell.textContent.replace(/(\r\n|\n|\r)/gm, "").trim();
                header.push(text);
            });
            csv.push(header.join(','));

            // 處理資料行 (TD)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const cols = row.querySelectorAll('td');
                let rowData = [];

                cols.forEach((col, colIndex) => {
                    let text = '';
                    
                    if (tableId === 'materialSummaryContent') {
                        // 素材總整理的特殊處理
                        if (colIndex === 2) { // 需要素材
                            const tags = col.querySelectorAll('.material-tag');
                            text = Array.from(tags).map(tag => tag.textContent).join(';');
                        } else if (colIndex === 3) { // 需求通路
                            const tags = col.querySelectorAll('.channel-tag');
                            text = Array.from(tags).map(tag => tag.textContent).join(';');
                        } else {
                            text = col.textContent.replace(/(\r\n|\n|\r)/gm, ' ').replace(/,/, '，').trim();
                        }
                    } else if (tableId === 'priceTableContent') {
                        // 價格總覽的特殊處理：抓取價格/成本/利潤
                        const priceDetails = [];
                        col.querySelectorAll('div').forEach(div => {
                            if (div.style.color === 'rgb(153, 153, 153)' || !div.querySelector('strong')) {
                                return;
                            }
                            const cleanText = div.textContent.replace(/(\r\n|\n|\r)/gm, ' ').trim();
                            priceDetails.push(cleanText.replace(/,/g, '，').replace(/:/g, '：'));
                        });
                        text = priceDetails.join(' | ');
                        
                        // 針對前兩欄（品牌和SKU）使用純淨文字
                        if (colIndex < 2) {
                            text = col.textContent.replace(/(\r\n|\n|\r)/gm, ' ').replace(/,/g, '，').trim();
                        } else if (text === '' && col.textContent.includes('未上架')) {
                             text = '未上架';
                        }
                    } else {
                         // 一般欄位清理
                        text = col.textContent.replace(/(\r\n|\n|\r)/gm, ' ').replace(/,/, '，').trim();
                    }
                    
                    rowData.push(`"${text}"`); 
                });
                csv.push(rowData.join(','));
            }

            // 創建 Blob 和下載連結 (支援中文編碼)
            const csvFile = new Blob(["\uFEFF", csv.join('\n')], { type: 'text/csv;charset=utf-8;' }); // 加入 BOM
            const downloadLink = document.createElement('a');
            
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // ====================================================================
        // II. 原始資料設定
        // ====================================================================
        const channels = {
            phase1: [
                { name: 'momo購物網', type: 'online' },
                { name: 'PChome 24h', type: 'online' },
                { name: 'iFind 品牌官網', type: 'online' },
                { name: '樂天市場', type: 'online' },
                { name: '蝦皮賣場 A', type: 'online' },
                { name: '蝦皮賣場 B', type: 'online' },
                { name: '蝦皮賣場 C', type: 'online' },
                { name: '有品味官網', type: 'online' },
                { name: '媽咪愛', type: 'online' },
                { name: 'Friday購物', type: 'online' },
                { name: '全電商', type: 'online' },
                { name: '酷澎商城', type: 'online' },
                { name: 'MO店家', type: 'online' }
            ],
            phase2: [
                { name: '美賣', type: 'offline' },
                { name: '真愛大健康', type: 'offline' },
                { name: '上發科技', type: 'offline' },
                { name: '化石先生', type: 'offline' },
                { name: '花蓮遠雄', type: 'offline' },
                { name: '好伴旅', type: 'offline' },
                { name: '哈韓孕媽咪', type: 'offline' },
                { name: '樂比比', type: 'offline' },
                { name: '實誠元和', type: 'offline' },
                { name: '澳利購', type: 'offline' },
                { name: '所以國際', type: 'offline' },
                { name: '韓豆路', type: 'offline' },
                { name: '芯享國際', type: 'offline' },
                { name: '精實國際', type: 'offline' },
                { name: '奧世國際', type: 'offline' },
                { name: '軒予國際', type: 'offline' },
                { name: '鈦德', type: 'offline' },
                { name: 'Kenny', type: 'offline' },
                { name: '雨傘王', type: 'offline' }
            ],
            phase3: [
                { name: '團購主-Nai', type: 'group' },
                { name: '團購主-CS Kids', type: 'group' },
                { name: '團購主-DEMY', type: 'group' },
                { name: '團購主-楊小花', type: 'group' },
                { name: '團購主-蘇菲', type: 'group' },
                { name: '團購主-CJ Lin', type: 'group' },
                { name: '團購主-陳筠柔', type: 'group' },
                { name: '團購主-張珊珊', type: 'group' },
                { name: '團購主-日常童著', type: 'group' },
                { name: '團購主-ICE', type: 'group' },
                { name: '團購主-卡拉Kara', type: 'group' },
                { name: '團購主-哈比', type: 'group' },
                { name: '團購主-戴柔兒', type: 'group' },
                { name: '團購主-頭頭', type: 'group' },
                { name: '團購主-宜寧', type: 'group' },
                { name: '團購主-Vimy Store', type: 'group' },
                { name: '團購主-Young', type: 'group' },
                { name: '團購主-小O', type: 'group' },
                { name: '團購主-雲玫', type: 'group' },
                { name: '團購主-雯雯', type: 'group' }
            ]
        };

        const brands = {
            iFind: {
                name: 'iFind 定位器',
                icon: '📍',
                skus: [
                    '波紋黑+保護套(6色選1)',
                    '波紋銀灰+保護套(6色選1)',
                    '救援小英雄波力聯名-波紋黑',
                    '救援小英雄波力聯名-波紋銀灰',
                    '小行星聯名x樂樂-波紋黑',
                    '小行星聯名x樂樂-波紋灰',
                    '安卓版(黑)+保護套(6色選1)',
                    '安卓版(白)+保護套(6色選1)',
                    '救援小英雄波力聯名-(安卓)黑',
                    '救援小英雄波力聯名-(安卓)白',
                    '波紋黑+寵物保護套(10色選1)',
                    '波紋銀灰+寵物保護套(10色選1)',
                    '(安卓)黑+寵物保護套(10色選1)',
                    '(安卓)白+寵物保護套(10色選1)',
                    '三麗鷗聯名-波紋黑',
                    '三麗鷗聯名-波紋銀灰',
                    '三麗鷗聯名-(安卓)黑',
                    '三麗鷗聯名-(安卓)白',
                    'iFind保護套(6色)'
                ]
            },
            LOHOY: {
                name: 'LOHOY 童趣圓夢傘',
                icon: '☂️',
                skus: [
                    '童趣圓夢傘-小恐龍', '童趣圓夢傘-小老虎', '童趣圓夢傘-哈囉胖達',
                    '童趣圓夢傘-萌狗貝利', '童趣圓夢傘-動物森林', '童趣圓夢傘-貝爾熊',
                    '童趣圓夢傘-萊恩獅', '童趣圓夢傘-方舟派對', '童趣圓夢傘-蒲英逐夢',
                    '童趣圓夢傘-笑傲飛兔', '童趣圓夢傘-異想世界', '童趣圓夢傘-草地聊哇',
                    '童趣圓夢傘-橙意水豚', '童趣圓夢傘-微喵微翹',
                    '童趣圓夢傘-救援小英雄波力聯名-波力',
                    '童趣圓夢傘-救援小英雄波力聯名-安寶',
                    '童趣圓夢傘-救援小英雄波力聯名-總動員',
                    '童趣圓夢傘-親子天下賴馬聯名-愛哭公主',
                    '童趣圓夢傘-親子天下賴馬聯名-生氣王子',
                    '童趣圓夢傘-小兒子阿甯咕聯名-阿甯咕的飛行傘',
                    '摺疊圓夢傘-小恐龍', '摺疊圓夢傘-小老虎', '摺疊圓夢傘-萌狗貝利',
                    '摺疊圓夢傘-方舟派對', '摺疊圓夢傘-笑傲飛兔', '摺疊圓夢傘-蒲英逐夢',
                    '摺疊圓夢傘-動物森林', '摺疊圓夢傘-森林聚哇', '摺疊圓夢傘-微喵微翹',
                    '摺疊圓夢傘-親子天下達克比聯名-米白配件',
                    '摺疊圓夢傘-親子天下達克比聯名-橘紅經典'
                ]
            },
            HappyNut: {
                name: 'Happy Nut 夏威夷豆',
                icon: '🥜',
                skus: [
                    '澳洲快樂果火山豆-單包',
                    '澳洲快樂果火山豆-3包組',
                    '澳洲快樂果火山豆-6包組+(贈)品牌野餐袋',
                    '(六個月內)澳洲快樂果火山豆-單包',
                    '(六個月內)澳洲快樂果火山豆-5包組'
                ]
            },
            NETTEC: {
                name: '優樂兒童電動牙刷',
                icon: '🪥',
                skus: [
                    '兒童U型電動牙刷 酷洛米+贈品',
                    '兒童U型電動牙刷 大耳狗+贈品',
                    '兒童U型電動牙刷 Hello Kitty+贈品',
                    '兒童U型電動牙刷 獅子王+贈品',
                    '兒童U型電動牙刷 彭彭+贈品',
                    '加價購-U型牙刷頭',
                    '加價購-萬毛牙刷頭',
                    '加價購-護齒泡沫牙膏',
                    '四入U型牙刷頭',
                    '四入萬毛牙刷頭'
                ]
            }
        };

        let channelData = {};
        let currentChannel = null;
        let activeBrandFilter = 'all';
        let activeChannelTypeFilter = 'all';
        let materialNeeds = {}; // 素材需求數據
        let currentMaterialTab = 'needed';
        let priceData = {}; // 價格數據

        const materialTypes = [
            { id: 'main', label: '主圖' },
            { id: 'detail', label: '情境圖' },
            { id: 'size', label: '尺寸圖' },
            { id: 'video', label: '影片' },
            { id: 'banner', label: 'Banner' },
            { id: 'infographic', label: '資訊圖' }
        ];

        // ====================================================================
        // III. 資料初始化與儲存
        // ====================================================================
        
        function initializeData() {
            Object.keys(channels).forEach(phase => {
                channels[phase].forEach(channel => {
                    if (!channelData[channel.name]) {
                        channelData[channel.name] = {};
                        Object.keys(brands).forEach(brandId => {
                            channelData[channel.name][brandId] = brands[brandId].skus.map(() => false);
                        });
                    }
                    
                    // 初始化素材需求數據
                    if (!materialNeeds[channel.name]) {
                        materialNeeds[channel.name] = {};
                        Object.keys(brands).forEach(brandId => {
                            materialNeeds[channel.name][brandId] = brands[brandId].skus.map(() => ({
                                types: {},
                                note: '',
                                completed: false
                            }));
                        });
                    }
                    
                    // 初始化價格數據（按通路）
                    if (!priceData[channel.name]) {
                        priceData[channel.name] = {};
                        Object.keys(brands).forEach(brandId => {
                            priceData[channel.name][brandId] = brands[brandId].skus.map(() => ({
                                price: '',
                                cost: '',
                                note: ''
                            }));
                        });
                    }
                });
            });
            
            loadFromStorage();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('channelDataV3', JSON.stringify(channelData));
                localStorage.setItem('materialNeedsV1', JSON.stringify(materialNeeds));
                localStorage.setItem('priceDataV2', JSON.stringify(priceData));
            } catch (e) {
                console.error('儲存失敗:', e);
            }
        }

        function loadFromStorage() {
            try {
                const data = localStorage.getItem('channelDataV3');
                if (data) {
                    channelData = JSON.parse(data);
                }
                
                const materials = localStorage.getItem('materialNeedsV1');
                if (materials) {
                    materialNeeds = JSON.parse(materials);
                }
                
                const prices = localStorage.getItem('priceDataV2');
                if (prices) {
                    priceData = JSON.parse(prices);
                }
            } catch (e) {
                console.error('讀取失敗:', e);
            }
        }

        // ====================================================================
        // IV. 通路卡片與篩選器
        // ====================================================================
        
        function createChannelCard(channel) {
            const card = document.createElement('div');
            card.className = `channel-card ${channel.type}`;
            card.setAttribute('data-type', channel.type);

            const typeText = {
                'online': '線上',
                'offline': '線下',
                'group': '團購主'
            }[channel.type];
            
            let selectedCount = 0;
            let totalCount = 0;
            Object.keys(brands).forEach(brandId => {
                if (activeBrandFilter === 'all' || activeBrandFilter === brandId) {
                    const brandData = channelData[channel.name][brandId];
                    selectedCount += brandData.filter(Boolean).length;
                    totalCount += brandData.length;
                }
            });

            card.innerHTML = `
                <div class="channel-header">
                    <span class="channel-name">${channel.name}</span>
                    <span class="channel-type">${typeText}</span>
                </div>
                <div style="margin-top: 10px; padding: 12px; background: white; border-radius: 6px; cursor: pointer;" onclick="openSKUModal('${channel.name}')">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-size: 14px; color: #666;">已選商品</span>
                        <span style="font-size: 18px; font-weight: bold; color: #667eea;">${selectedCount} / ${totalCount}</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #999;">點擊選擇商品 →</div>
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button class="material-btn" style="flex: 1;" onclick="event.stopPropagation(); openMaterialModal('${channel.name}')">
                        📸 素材需求
                    </button>
                    <button class="material-btn" style="flex: 1; background: #4ecdc4;" onmouseover="this.style.background='#44a08d'" onmouseout="this.style.background='#4ecdc4'" onclick="event.stopPropagation(); openChannelPriceManager('${channel.name}')">
                        💰 通路定價
                    </button>
                </div>
            `;

            return card;
        }

        function renderAllChannels() {
            ['phase1', 'phase2', 'phase3'].forEach(phaseId => {
                const container = document.getElementById(phaseId);
                container.innerHTML = '';
                channels[phaseId].forEach(channel => {
                    if (activeChannelTypeFilter === 'all' || activeChannelTypeFilter === channel.type) {
                        container.appendChild(createChannelCard(channel));
                    }
                });
            });
            updateStats();
        }

        function filterBrand(brand) {
            activeBrandFilter = brand;
            document.querySelectorAll('.brand-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderAllChannels();
        }

        function filterChannelType(type) {
            activeChannelTypeFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAllChannels();
        }

        function updateStats() {
            let totalSelected = 0;
            let totalPossible = 0;
            let totalMaterialNeeded = 0;
            let totalMaterialComplete = 0;

            Object.keys(channelData).forEach(channelName => {
                Object.keys(brands).forEach(brandId => {
                    totalSelected += channelData[channelName][brandId].filter(Boolean).length;
                    totalPossible += channelData[channelName][brandId].length;
                    
                    // 計算素材需求
                    channelData[channelName][brandId].forEach((selected, index) => {
                        const materialData = materialNeeds[channelName][brandId][index];
                        const hasNeeds = Object.keys(materialData.types).some(key => materialData.types[key]) || materialData.note.trim() !== '';
                            
                        if (hasNeeds) {
                            if (materialData.completed) {
                                totalMaterialComplete++;
                            } else {
                                totalMaterialNeeded++;
                            }
                        }
                    });
                });
            });

            const percentage = totalPossible > 0 ? Math.round((totalSelected / totalPossible) * 100) : 0;
            document.getElementById('completionRate').textContent = `${percentage}%`;
            
            // 更新素材統計
            document.getElementById('totalMaterialNeeded').textContent = totalMaterialNeeded;
            document.getElementById('totalMaterialComplete').textContent = totalMaterialComplete;
            
            const totalMaterial = totalMaterialNeeded + totalMaterialComplete;
            const materialPercentage = totalMaterial > 0 ? Math.round((totalMaterialComplete / totalMaterial) * 100) : 0;
            document.getElementById('materialProgress').textContent = `${materialPercentage}%`;
        }

        // ====================================================================
        // V. SKU 選擇模態框
        // ====================================================================

        function openSKUModal(channelName) {
            currentChannel = channelName;
            document.getElementById('modalTitle').textContent = `${channelName} - 選擇上架商品`;
            
            const grid = document.getElementById('skuBrandGrid');
            grid.innerHTML = '';

            Object.keys(brands).forEach(brandId => {
                if (activeBrandFilter !== 'all' && activeBrandFilter !== brandId) return;

                const brand = brands[brandId];
                const brandCard = document.createElement('div');
                brandCard.className = 'brand-card';

                let skuHTML = `<div class="brand-card-header">${brand.icon} ${brand.name} (${brand.skus.length})</div>`;
                
                brand.skus.forEach((sku, index) => {
                    const checked = channelData[channelName][brandId][index] ? 'checked' : '';
                    skuHTML += `
                        <div class="sku-item">
                            <input type="checkbox" ${checked} 
                                onchange="toggleSKU('${brandId}', ${index})" 
                                id="sku-${brandId}-${index}">
                            <span class="sku-name">${sku}</span>
                        </div>
                    `;
                });

                brandCard.innerHTML = skuHTML;
                grid.appendChild(brandCard);
            });

            document.getElementById('skuModal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('skuModal').classList.remove('show');
        }

        function toggleSKU(brandId, index) {
            channelData[currentChannel][brandId][index] = !channelData[currentChannel][brandId][index];
        }

        function selectAllSKUs() {
            Object.keys(brands).forEach(brandId => {
                if (activeBrandFilter !== 'all' && activeBrandFilter !== brandId) return;
                brands[brandId].skus.forEach((_, index) => {
                    channelData[currentChannel][brandId][index] = true;
                    const checkbox = document.getElementById(`sku-${brandId}-${index}`);
                    if (checkbox) checkbox.checked = true;
                });
            });
        }

        function saveSKUSelection() {
            saveToStorage();
            closeModal();
            renderAllChannels();
        }
        
        // ====================================================================
        // VI. 素材需求管理模態框 (已修改 renderMaterialContent 邏輯，允許未勾選填寫)
        // ====================================================================
        
        // 刪除單一 SKU 的素材需求記錄
        function deleteMaterialNeed(brandId, skuIndex) {
            if (confirm(`確定要清除通路 ${currentChannel} 下 ${brands[brandId].skus[skuIndex]} 的所有素材需求記錄嗎？\n(這將無法復原)`)) {
                // 重設該 SKU 的所有素材需求和備註
                materialNeeds[currentChannel][brandId][skuIndex] = {
                    types: {},
                    note: '',
                    completed: false
                };
                saveToStorage();
                renderMaterialContent(); // 重新渲染列表
                updateStats(); // 更新統計數據
            }
        }

        function openMaterialModal(channelName) {
            currentChannel = channelName;
            document.getElementById('materialModalTitle').textContent = `${channelName} - 素材需求管理`;
            currentMaterialTab = 'needed';
            
            // 重置 tab 按鈕
            document.querySelectorAll('#materialModal .tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('#materialModal .tab-btn')[0].classList.add('active');
            
            renderMaterialContent();
            document.getElementById('materialModal').classList.add('show');
        }

        function closeMaterialModal() {
            document.getElementById('materialModal').classList.remove('show');
        }

        function switchMaterialTab(tab) {
            currentMaterialTab = tab;
            document.querySelectorAll('#materialModal .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            renderMaterialContent();
        }

        function renderMaterialContent() {
            const content = document.getElementById('materialContent');
            content.innerHTML = '';
            
            let neededCount = 0;
            let completeCount = 0;
            
            Object.keys(brands).forEach(brandId => {
                const brand = brands[brandId];
                const displaySKUs = []; 
                
                brand.skus.forEach((sku, index) => {
                    const isSelected = channelData[currentChannel][brandId][index];
                    const materialData = materialNeeds[currentChannel][brandId][index];
                    const hasNeeds = Object.keys(materialData.types).some(key => materialData.types[key]) || materialData.note.trim() !== '';

                    // 邏輯：所有 SKU 無條件顯示在 'needed' 分頁中，以便填寫需求。
                    // 在 'complete' 分頁中，只顯示有記錄的 SKU。
                    
                    // 計算統計數字（不變）
                    if (hasNeeds) {
                        if (materialData.completed) {
                            completeCount++;
                        } else {
                            neededCount++;
                        }
                    }
                    
                    let shouldDisplay = false;
                    
                    if (currentMaterialTab === 'needed') {
                        // 在「缺素材」分頁：顯示所有 SKU
                        shouldDisplay = true;
                    } else if (currentMaterialTab === 'complete' && hasNeeds) {
                        // 在「已完成」分頁：只顯示有記錄的 SKU
                        shouldDisplay = true;
                    }

                    if (shouldDisplay) {
                        // 根據當前 tab 篩選
                        if ((currentMaterialTab === 'needed' && !materialData.completed) ||
                            (currentMaterialTab === 'complete' && materialData.completed)) {
                            
                            displaySKUs.push({ index, sku, materialData, isSelected });
                        } else if (currentMaterialTab === 'needed' && !hasNeeds && !materialData.completed) {
                            // 在「缺素材」頁面，如果目前沒有記錄但未完成，也顯示出來讓用戶可以輸入
                            displaySKUs.push({ index, sku, materialData, isSelected });
                        }
                    }
                });
                
                // 再次過濾：確保「已完成」頁面只顯示已完成的項目，且避免重複添加
                const finalDisplaySKUs = [];
                const addedIndices = new Set();
                
                brand.skus.forEach((sku, index) => {
                    const isSelected = channelData[currentChannel][brandId][index];
                    const materialData = materialNeeds[currentChannel][brandId][index];
                    const hasNeeds = Object.keys(materialData.types).some(key => materialData.types[key]) || materialData.note.trim() !== '';
                    
                    const itemData = { index, sku, materialData, isSelected };
                    const key = `${brandId}-${index}`;
                    
                    if (currentMaterialTab === 'needed') {
                        // 顯示所有未完成的項目，無論是否有需求記錄（因為可以輸入）
                        if (!materialData.completed && !addedIndices.has(key)) {
                            finalDisplaySKUs.push(itemData);
                            addedIndices.add(key);
                        }
                    } else if (currentMaterialTab === 'complete') {
                        // 顯示所有已完成的項目
                        if (materialData.completed && hasNeeds && !addedIndices.has(key)) {
                            finalDisplaySKUs.push(itemData);
                            addedIndices.add(key);
                        }
                    }
                });


                // 如果有 SKU 需要顯示
                if (finalDisplaySKUs.length > 0) {
                    const brandSection = document.createElement('div');
                    brandSection.className = 'material-section';
                    brandSection.innerHTML = `<h3 style="margin-bottom: 15px; color: #333;">${brand.icon} ${brand.name}</h3>`;
                    
                    finalDisplaySKUs.forEach(({ index, sku, materialData, isSelected }) => {
                        const item = document.createElement('div');
                        item.className = 'material-item';
                        
                        let typesHTML = '<div class="material-types">';
                        materialTypes.forEach(type => {
                            const checked = materialData.types[type.id] ? 'checked' : '';
                            typesHTML += `
                                <label class="material-checkbox">
                                    <input type="checkbox" ${checked} 
                                        onchange="updateMaterialType('${brandId}', ${index}, '${type.id}', this.checked)">
                                    <span>${type.label}</span>
                                </label>
                            `;
                        });
                        typesHTML += '</div>';
                        
                        const completedChecked = materialData.completed ? 'checked' : '';
                        const completedClass = materialData.completed ? 'completed' : '';
                        const unselectedClass = !isSelected ? 'unselected' : ''; 
                        
                        item.innerHTML = `
                            <div class="material-header">
                                <span class="material-sku-name ${completedClass} ${unselectedClass}">${sku} ${!isSelected ? '(未上架)' : ''}</span>
                                <div style="display: flex; align-items: center;">
                                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                                        <input type="checkbox" ${completedChecked} 
                                            onchange="updateMaterialCompleted('${brandId}', ${index}, this.checked)">
                                        <span style="font-size: 13px; color: #4caf50;">已完成</span>
                                    </label>
                                    <button class="delete-btn" title="清除此 SKU 的素材需求記錄" 
                                        onclick="deleteMaterialNeed('${brandId}', ${index})">
                                        &times;
                                    </button>
                                </div>
                            </div>
                            ${typesHTML}
                            <textarea class="material-note" 
                                placeholder="備註說明（例如：需要白底去背主圖、需要 16:9 橫版影片...）"
                                onchange="updateMaterialNote('${brandId}', ${index}, this.value)">${materialData.note || ''}</textarea>
                        `;
                        
                        brandSection.appendChild(item);
                    });
                    
                    content.appendChild(brandSection);
                }
            });
            
            // 更新計數
            document.getElementById('neededCount').textContent = neededCount;
            document.getElementById('completeCount').textContent = completeCount;
            
            if (content.children.length === 0) {
                content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">目前沒有資料</div>';
            }
        }

        function updateMaterialType(brandId, skuIndex, typeId, checked) {
            materialNeeds[currentChannel][brandId][skuIndex].types[typeId] = checked;
        }

        function updateMaterialNote(brandId, skuIndex, note) {
            materialNeeds[currentChannel][brandId][skuIndex].note = note;
        }

        function updateMaterialCompleted(brandId, skuIndex, completed) {
            materialNeeds[currentChannel][brandId][skuIndex].completed = completed;
            renderMaterialContent(); 
        }

        function saveMaterialNeeds() {
            saveToStorage();
            closeMaterialModal();
            updateStats();
            alert('素材需求已儲存！');
        }
        
        // ====================================================================
        // VII. 素材需求總整理模態框
        // ====================================================================

        function openMaterialSummary() {
            const content = document.getElementById('materialSummaryContent');
            let html = '<table class="summary-table" id="materialSummaryTable">'; 
            html += `
                <thead>
                    <tr>
                        <th style="min-width: 150px;">品牌</th>
                        <th style="min-width: 250px;">SKU</th>
                        <th style="min-width: 150px;">需要素材</th>
                        <th style="min-width: 200px;">需求通路</th>
                        <th style="min-width: 300px;">備註說明</th>
                        <th style="width: 80px;">狀態</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // 收集所有素材需求
            const summaryData = [];
            
            Object.keys(brands).forEach(brandId => {
                const brand = brands[brandId];
                
                brand.skus.forEach((sku, skuIndex) => {
                    const needsList = [];
                    const channelsList = [];
                    const notesList = [];
                    let isCompleted = true;
                    let hasNeeds = false;
                    
                    Object.keys(channelData).forEach(channelName => {
                        const materialData = materialNeeds[channelName][brandId][skuIndex];
                        const neededTypes = Object.keys(materialData.types).filter(t => materialData.types[t]);
                        
                        // 檢查是否有任何素材需求
                        if (neededTypes.length > 0 || materialData.note.trim() !== '') {
                            hasNeeds = true;
                            
                            // 標示未上架
                            const isSelected = channelData[channelName][brandId][skuIndex];
                            channelsList.push(channelName + (isSelected ? '' : ' (未上架)')); 
                            
                            neededTypes.forEach(type => {
                                const typeLabel = materialTypes.find(t => t.id === type)?.label || type;
                                if (!needsList.includes(typeLabel)) {
                                    needsList.push(typeLabel);
                                }
                            });
                            
                            if (materialData.note) {
                                notesList.push(`${channelName}: ${materialData.note}`);
                            }
                            
                            if (!materialData.completed) {
                                isCompleted = false;
                            }
                        }
                    });
                    
                    if (hasNeeds) {
                        summaryData.push({
                            brandName: brand.name,
                            brandIcon: brand.icon,
                            sku,
                            needs: needsList,
                            channels: channelsList,
                            notes: notesList,
                            completed: isCompleted
                        });
                    }
                });
            });

            // 渲染表格
            if (summaryData.length === 0) {
                html += '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #999;">目前沒有素材需求</td></tr>';
            } else {
                summaryData.forEach(item => {
                    const statusColor = item.completed ? '#4caf50' : '#ff9800';
                    const statusText = item.completed ? '✓ 完成' : '待製作';
                    
                    html += `
                        <tr>
                            <td><strong>${item.brandIcon} ${item.brandName}</strong></td>
                            <td>${item.sku}</td>
                            <td>
                                ${item.needs.map(n => `<span class="material-tag">${n}</span>`).join('')}
                            </td>
                            <td>
                                ${item.channels.map(c => `<span class="channel-tag" style="${c.includes('(未上架)') ? 'background: #fbe9e7; color: #d32f2f;' : ''}">${c}</span>`).join('')}
                            </td>
                            <td style="font-size: 12px; color: #666;">
                                ${item.notes.join('<br>')}
                            </td>
                            <td style="color: ${statusColor}; font-weight: 600;">${statusText}</td>
                        </tr>
                    `;
                });
            }

            html += '</tbody></table>';
            content.innerHTML = html;
            document.getElementById('materialSummaryModal').classList.add('show');
        }

        function closeMaterialSummary() {
            document.getElementById('materialSummaryModal').classList.remove('show');
        }

        function exportMaterialSummary() {
            exportTableToCSV('materialSummaryContent', '商品素材需求總整理.csv');
        }
        
        // ====================================================================
        // VIII. 價格管理模態框 (已修復價格總覽顯示邏輯)
        // ====================================================================

        function openGlobalPriceManager() {
            openPriceManager();
        }

        function openPriceManager() {
            const content = document.getElementById('priceContent');
            
            // 先顯示分頁按鈕
            let html = `
                <div class="tab-buttons" style="margin-bottom: 20px;">
                    <button class="tab-btn active" onclick="switchPriceTab('online')">線上通路 (13)</button>
                    <button class="tab-btn" onclick="switchPriceTab('offline')">線下通路 (19)</button>
                    <button class="tab-btn" onclick="switchPriceTab('group')">團購主 (20)</button>
                </div>
                <div id="priceTableContent"></div>
            `;
            
            content.innerHTML = html;
            document.getElementById('priceModal').classList.add('show');
            
            // 預設顯示線上通路
            switchPriceTab('online');
        }

        function switchPriceTab(channelType) {
            // 更新按鈕狀態
            const buttons = document.querySelectorAll('#priceContent .tab-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
                if ((btn.textContent.includes('線上') && channelType === 'online') ||
                    (btn.textContent.includes('線下') && channelType === 'offline') ||
                    (btn.textContent.includes('團購') && channelType === 'group')) {
                    btn.classList.add('active');
                }
            });
            
            // 取得該類型的通路
            const filteredChannels = [];
            Object.keys(channels).forEach(phase => {
                channels[phase].forEach(channel => {
                    if (channel.type === channelType) {
                        filteredChannels.push(channel.name);
                    }
                });
            });
            
            // 生成表格
            let tableHTML = '<div style="overflow-x: auto;"><table class="summary-table">';
            tableHTML += `
                <thead>
                    <tr>
                        <th style="min-width: 120px; position: sticky; left: 0; background: #f8f9fa; z-index: 11;">品牌</th>
                        <th style="min-width: 200px; position: sticky; left: 120px; background: #f8f9fa; z-index: 11;">SKU</th>
            `;
            
            tableHTML += filteredChannels.map(ch => `<th style="min-width: 150px;">${ch}<br>(定價資訊)</th>`).join('');
            tableHTML += '</tr></thead><tbody>';
            
            let hasData = false;
            
            // 遍歷所有品牌
            ['iFind', 'LOHOY', 'HappyNut', 'NETTEC'].forEach(brandId => {
                if (!brands[brandId]) return;
                
                const brand = brands[brandId];
                
                brand.skus.forEach((sku, skuIndex) => {
                    hasData = true;
                    tableHTML += `
                        <tr>
                            <td style="position: sticky; left: 0; background: white; z-index: 10;"><strong>${brand.icon} ${brand.name}</strong></td>
                            <td style="position: sticky; left: 120px; background: white; z-index: 10;">${sku}</td>
                    `;
                    
                    // 顯示當前類型各通路的價格
                    filteredChannels.forEach(channelName => {
                        const selected = channelData[channelName] && 
                                       channelData[channelName][brandId] && 
                                       channelData[channelName][brandId][skuIndex];
                        const priceInfo = priceData[channelName] && 
                                        priceData[channelName][brandId] && 
                                        priceData[channelName][brandId][skuIndex] || 
                                        { price: '', cost: '', note: '' };

                        // 檢查是否有填寫價格或成本
                        const hasPriceData = priceInfo.price.trim() !== '' || priceInfo.cost.trim() !== '';

                        if (selected || hasPriceData) { // 只要勾選 OR 有價格資料就顯示
                            const price = parseFloat(priceInfo.price) || 0;
                            const cost = parseFloat(priceInfo.cost) || 0;
                            const profit = (price - cost).toFixed(0);
                            const profitColor = profit > 0 ? '#4caf50' : (profit < 0 ? '#ff6b6b' : '#999');
                            const margin = price > 0 ? 
                                ((price - cost) / price * 100).toFixed(1) : '-';
                            
                            const backgroundStyle = selected ? '#fffef0' : '#f8f8f8'; // 未勾選但有價格數據時，背景稍暗
                            
                            tableHTML += `
                                <td style="font-size: 12px; background: ${backgroundStyle};">
                                    ${!selected ? `<div style="color: #d32f2f; font-weight: 600; margin-bottom: 4px;">未上架</div>` : ''}
                                    <div style="margin-bottom: 4px;"><strong>售：</strong>${priceInfo.price || '-'} 元</div>
                                    <div style="margin-bottom: 4px;"><strong>成本：</strong>${priceInfo.cost || '-'} 元</div>
                                    <div style="color: ${profitColor}; margin-bottom: 4px;"><strong>利潤：</strong>${profit} 元</div>
                                    <div style="color: ${profitColor};"><strong>毛利：</strong>${margin}%</div>
                                    ${priceInfo.note ? `<div style="color: #999; font-size: 11px; margin-top: 4px; border-top: 1px solid #e0e0e0; padding-top: 4px;">${priceInfo.note}</div>` : ''}
                                </td>
                            `;
                        } else {
                            tableHTML += '<td style="color: #ccc; text-align: center; background: #fafafa;">無數據</td>'; // 未上架且無數據
                        }
                    });
                    
                    tableHTML += '</tr>';
                });
            });
            
            tableHTML += '</tbody></table></div>';
            
            const tableContent = document.getElementById('priceTableContent');
            tableContent.innerHTML = tableHTML;
        }

        function exportPriceSummary() {
            exportTableToCSV('priceTableContent', '全通路價格總覽.csv');
        }

        function closePriceManager() {
            document.getElementById('priceModal').classList.remove('show');
        }
        
        // 單一通路定價管理
        function openChannelPriceManager(channelName) {
            currentChannel = channelName;
            document.getElementById('channelPriceTitle').textContent = `${channelName} - 通路定價管理`;
            
            const content = document.getElementById('channelPriceContent');
            let html = '';

            // 遍歷所有品牌
            Object.keys(brands).forEach(brandId => {
                const brand = brands[brandId];
                
                // 開始品牌區塊
                html += `
                    <div style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                            ${brand.icon} ${brand.name}
                        </h3>
                `;

                // 遍歷所有 SKU
                brand.skus.forEach((sku, index) => {
                    const isSelected = channelData[channelName][brandId][index];
                    const prices = priceData[channelName][brandId][index];
                    const price = parseFloat(prices.price) || 0;
                    const cost = parseFloat(prices.cost) || 0;
                    const profit = (price - cost).toFixed(0);
                    const profitColor = profit > 0 ? '#4caf50' : (profit < 0 ? '#ff6b6b' : '#999');
                    
                    const sectionStyle = isSelected ? 'background: #fff;' : 'background: #f9f9f9; opacity: 0.7;';
                    const statusBadge = isSelected ? 
                        '<span style="background: #4caf50; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">✓ 已上架</span>' :
                        '<span style="background: #ccc; color: white; padding: 3px 8px; border-radius: 4px; font-size: 11px; margin-left: 10px;">未上架</span>';
                    
                    html += `
                        <div class="price-section" id="price-section-${brandId}-${index}" style="${sectionStyle}">
                            <div style="font-weight: 600; margin-bottom: 10px; color: #333;">
                                ${sku}
                                ${statusBadge}
                            </div>
                            <div class="price-row">
                                <span class="price-label">售價：</span>
                                <input type="number" class="price-input" placeholder="0" 
                                    value="${prices.price || ''}"
                                    oninput="updateChannelPrice('${channelName}', '${brandId}', ${index}, 'price', this.value)">
                                <span style="color: #999;">元</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">成本（含稅）：</span>
                                <input type="number" class="price-input" placeholder="0"
                                    value="${prices.cost || ''}"
                                    oninput="updateChannelPrice('${channelName}', '${brandId}', ${index}, 'cost', this.value)">
                                <span style="color: #999;">元</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">利潤：</span>
                                <span style="font-size: 18px; font-weight: bold; color: ${profitColor};" id="profit-${brandId}-${index}">${profit} 元</span>
                            </div>
                            <div class="price-row">
                                <span class="price-label">備註：</span>
                                <input type="text" style="flex: 1; padding: 6px; border: 1px solid #e0e0e0; border-radius: 4px;" 
                                    placeholder="例如：促銷價、會員價等"
                                    value="${prices.note || ''}"
                                    onchange="updateChannelPrice('${channelName}', '${brandId}', ${index}, 'note', this.value)">
                            </div>
                        </div>
                    `;
                });

                html += '</div>'; // 結束品牌區塊
            });
            
            if (!html) {
                html = '<div style="text-align: center; padding: 40px; color: #999;">此通路尚未選擇商品</div>';
            }

            content.innerHTML = html;
            document.getElementById('channelPriceModal').classList.add('show');
        }

        function closeChannelPriceManager() {
            document.getElementById('channelPriceModal').classList.remove('show');
        }

        function updateChannelPrice(channelName, brandId, skuIndex, priceType, value) {
            priceData[channelName][brandId][skuIndex][priceType] = value;
            
            // 即時更新利潤顯示
            const prices = priceData[channelName][brandId][skuIndex];
            const price = parseFloat(prices.price) || 0;
            const cost = parseFloat(prices.cost) || 0;
            const profit = (price - cost).toFixed(0);
            const profitColor = profit > 0 ? '#4caf50' : (profit < 0 ? '#ff6b6b' : '#999');
            
            const profitDisplay = document.getElementById(`price-section-${brandId}-${skuIndex}`).querySelector('.price-row:nth-child(4) span:last-child');
            if (profitDisplay) {
                profitDisplay.textContent = `${profit} 元`;
                profitDisplay.style.color = profitColor;
            }
        }

        function saveChannelPrices() {
            saveToStorage();
            closeChannelPriceManager();
            alert('定價已儲存！');
        }

        function closePriceManager() {
            document.getElementById('priceModal').classList.remove('show');
        }

        function filterBrand(brand) {
            activeBrandFilter = brand;
            document.querySelectorAll('.brand-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            renderAllChannels();
        }

        function filterChannelType(type) {
            activeChannelTypeFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAllChannels();
        }

        // 初始化
        initializeData();
        renderAllChannels();

        // 點擊 modal 外部關閉
        document.getElementById('skuModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('materialModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMaterialModal();
            }
        });

        document.getElementById('materialSummaryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMaterialSummary();
            }
        });

        document.getElementById('channelPriceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeChannelPriceManager();
            }
        });

        document.getElementById('priceModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePriceManager();
            }
        });
    </script>
</body>
</html>
